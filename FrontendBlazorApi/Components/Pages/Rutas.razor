@page "/rutas"
@using FrontendBlazorApi.Models
@using FrontendBlazorApi.Servicios
@using FrontendBlazorApi.Components
@using System.Text.Json
@inherits PaginaAutenticada
@inject ServicioApiGenerico servicioApi
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>Gestión de Rutas</PageTitle>

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <i class="bi bi-signpost-2 text-primary me-2"></i>
            Gestión de Rutas del Sistema
        </h2>
    </div>

    <!-- Alert informativa -->
    <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        <strong>Información:</strong> Administre las rutas disponibles en el sistema. Las rutas son los paths que pueden protegerse con permisos de roles.
    </div>

    <!-- Mensajes -->
    @if (!string.IsNullOrEmpty(mensaje))
    {
        <div class="@estiloMensaje alert-dismissible fade show shadow-sm" role="alert">
            <i class="bi @iconoMensaje me-2"></i>@mensaje
            <button type="button" class="btn-close" @onclick="() => mensaje = string.Empty"></button>
        </div>
    }

    <div class="row">
        <!-- Formulario para crear nueva ruta -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-plus-circle me-2"></i>
                        Nueva Ruta
                    </h5>
                </div>
                <div class="card-body">
                    <EditForm Model="rutaActual" OnValidSubmit="CrearRuta" FormName="formRuta">
                        <DataAnnotationsValidator />

                        <div class="mb-3">
                            <label for="ruta" class="form-label fw-bold">
                                <i class="bi bi-link-45deg"></i> Ruta (Path)
                            </label>
                            <InputText class="form-control"
                                       id="ruta"
                                       @bind-Value="rutaActual.Ruta"
                                       placeholder="/ejemplo" />
                            <small class="text-muted">Ejemplo: /usuarios, /facturas</small>
                            <ValidationMessage For="() => rutaActual.Ruta" />
                        </div>

                        <div class="mb-3">
                            <label for="descripcion" class="form-label fw-bold">
                                <i class="bi bi-card-text"></i> Descripción
                            </label>
                            <InputText class="form-control"
                                       id="descripcion"
                                       @bind-Value="rutaActual.Descripcion"
                                       placeholder="Breve descripción de la ruta"
                                       maxlength="255" />
                            <small class="text-muted">Explique qué hace esta ruta</small>
                            <ValidationMessage For="() => rutaActual.Descripcion" />
                        </div>

                        <button type="submit" class="btn btn-primary w-100" disabled="@cargando">
                            <i class="bi bi-plus-circle me-2"></i>
                            @(cargando ? "Creando..." : "Crear Ruta")
                        </button>
                    </EditForm>
                </div>
            </div>
        </div>

        <!-- Tabla de rutas existentes -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-list-ul me-2"></i>
                        Rutas Registradas
                        <span class="badge bg-primary ms-2">@rutas.Count</span>
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" @onclick="CargarRutas" disabled="@cargando">
                        <i class="bi bi-arrow-clockwise"></i> Recargar
                    </button>
                </div>
                <div class="card-body">
                    @if (cargando)
                    {
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-2 text-muted">Cargando rutas...</p>
                        </div>
                    }
                    else if (rutas == null || !rutas.Any())
                    {
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            No hay rutas registradas en el sistema.
                        </div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-hover table-bordered align-middle">
                                <thead class="table-primary">
                                    <tr>
                                        <th width="30%">Ruta</th>
                                        <th width="60%">Descripción</th>
                                        <th width="10%" class="text-center">Acción</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var ruta in rutas)
                                    {
                                        <tr>
                                            <td>
                                                <code class="text-primary fw-bold">@ruta.Ruta</code>
                                            </td>
                                            <td>@ruta.Descripcion</td>
                                            <td class="text-center">
                                                <button class="btn btn-outline-danger btn-sm"
                                                        @onclick="() => EliminarRuta(ruta.Ruta)"
                                                        disabled="@cargando"
                                                        title="Eliminar ruta">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private List<RutaDto> rutas = new();
    private RutaDto rutaActual = new();
    private bool cargando = false;
    private string mensaje = string.Empty;
    private string estiloMensaje = "alert-info";
    private string iconoMensaje = "bi-info-circle";

    protected override async Task OnAutenticacionVerificada()
    {
        // Este método se llama automáticamente después de verificar la autenticación
        await CargarDatosIniciales();
    }

    private async Task CargarDatosIniciales()
    {
        await CargarRutas();
    }

    private async Task CargarRutas()
    {
        try
        {
            cargando = true;
            mensaje = string.Empty;

            var respuesta = await servicioApi.ObtenerTodosAsync<RutaDto>("ruta");
            rutas = respuesta ?? new List<RutaDto>();

            MostrarMensaje($"Se cargaron {rutas.Count} rutas", "success");
        }
        catch (Exception ex)
        {
            MostrarMensaje($"Error al cargar rutas: {ex.Message}", "danger");
            rutas = new List<RutaDto>();
        }
        finally
        {
            cargando = false;
        }
    }

    private async Task CrearRuta()
    {
        try
        {
            cargando = true;

            // Validaciones
            if (string.IsNullOrWhiteSpace(rutaActual.Ruta))
            {
                MostrarMensaje("Debe ingresar la ruta", "warning");
                return;
            }

            if (!rutaActual.Ruta.StartsWith("/"))
            {
                MostrarMensaje("La ruta debe empezar con /", "warning");
                return;
            }

            if (string.IsNullOrWhiteSpace(rutaActual.Descripcion))
            {
                MostrarMensaje("Debe ingresar la descripción", "warning");
                return;
            }

            // Crear ruta usando la API
            await servicioApi.CrearAsync("ruta", rutaActual);

            MostrarMensaje($"Ruta '{rutaActual.Ruta}' creada exitosamente", "success");
            await CargarRutas();
            rutaActual = new RutaDto();
        }
        catch (Exception ex)
        {
            MostrarMensaje($"Error al crear ruta: {ex.Message}", "danger");
        }
        finally
        {
            cargando = false;
        }
    }

    private async Task EliminarRuta(string ruta)
    {
        try
        {
            var confirmacion = await JS.InvokeAsync<bool>("confirm",
                $"¿Está seguro de eliminar la ruta \"{ruta}\"?\n\nNota: No se puede eliminar si tiene permisos asociados.");

            if (!confirmacion) return;

            cargando = true;

            // Usar stored procedure para eliminar porque la ruta contiene '/'
            var parametros = new
            {
                p_ruta = ruta
            };

            await servicioApi.EjecutarStoredProcedureAsync("eliminar_ruta", parametros);

            MostrarMensaje($"Ruta eliminada exitosamente", "success");
            await CargarRutas();
        }
        catch (Exception ex)
        {
            MostrarMensaje($"Error al eliminar ruta: {ex.Message}", "danger");
        }
        finally
        {
            cargando = false;
        }
    }

    private void MostrarMensaje(string texto, string tipo)
    {
        mensaje = texto;
        estiloMensaje = tipo switch
        {
            "success" => "alert alert-success",
            "danger" => "alert alert-danger",
            "warning" => "alert alert-warning",
            _ => "alert alert-info"
        };
        iconoMensaje = tipo switch
        {
            "success" => "bi-check-circle",
            "danger" => "bi-exclamation-triangle",
            "warning" => "bi-exclamation-circle",
            _ => "bi-info-circle"
        };
    }

    // DTO para Ruta
    private class RutaDto
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "La ruta es requerida")]
        [System.ComponentModel.DataAnnotations.RegularExpression(@"^/.*", ErrorMessage = "La ruta debe empezar con /")]
        [System.Text.Json.Serialization.JsonPropertyName("ruta")]
        public string Ruta { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "La descripción es requerida")]
        [System.ComponentModel.DataAnnotations.MaxLength(255, ErrorMessage = "La descripción no puede exceder 255 caracteres")]
        [System.Text.Json.Serialization.JsonPropertyName("descripcion")]
        public string Descripcion { get; set; } = string.Empty;
    }
}
