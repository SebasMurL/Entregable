@page "/estados"
@using System.Net.Http.Json
@using FrontendBlazorApi.Models
@using FrontendBlazorApi.Servicios
@using FrontendBlazorApi.Components
@using System.Text.Json
@inject IHttpClientFactory fabricaHttp
@inject ServicioApiGenerico servicioApi
@inherits PaginaAutenticada
@rendermode InteractiveServer

<PageTitle>Estados</PageTitle>

@if (!AutenticacionVerificada)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2 text-muted">Verificando autenticaci√≥n...</p>
    </div>
}
else
{
    <h3>Gesti√≥n de Estados</h3>

    <div class="mb-3 d-flex gap-2">
        <button type="button" class="btn btn-outline-secondary" @onclick="ProbarConexion">Probar conexi√≥n</button>
        <button type="button" class="btn btn-outline-primary" @onclick="CargarEstados">Mostrar todos</button>
        <button type="button" class="btn btn-outline-dark" @onclick="LimpiarFormulario">Limpiar</button>
        <button type="button" class="btn btn-info" @onclick="VerificarEstadoAutenticacion">
    Verificar Autenticaci√≥n
</button>
    </div>

    @if (!string.IsNullOrWhiteSpace(mensaje))
    {
        <div class="@claseAviso" role="alert">@mensaje</div>
    }

    <h4>Formulario de Estado</h4>
    <EditForm Model="estadoActual" OnValidSubmit="GuardarSegunEstado" FormName="EstadoForm">
        <DataAnnotationsValidator />
        <ValidationSummary />
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">ID</label>
                <InputNumber class="form-control" @bind-Value="estadoActual.Id" readonly="@existeEstado" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Nombre</label>
                <InputText class="form-control" @bind-Value="estadoActual.Nombre" />
            </div>
            <div class="col-md-5">
                <label class="form-label">Descripci√≥n</label>
                <InputText class="form-control" @bind-Value="estadoActual.Descripcion" />
            </div>
        </div>
        <div class="mt-3 d-flex flex-wrap gap-2">
            <button type="submit" class="btn btn-primary">@textoBotonGuardar</button>
            <button type="button" class="btn btn-secondary" @onclick="BuscarPorId">Buscar</button>
            <button type="button" class="btn btn-danger" @onclick="EliminarEstado" disabled="@(!existeEstado)">Eliminar</button>
        </div>
    </EditForm>

    <hr />

    @if (cargando)
    {
        <p><em>Cargando estados...</em></p>
    }
    else if (listaEstados.Count == 0)
    {
        <p>No hay estados disponibles.</p>
    }
    else
    {
         <table class="table table-striped table-bordered align-middle">
             <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Descripci√≥n</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var estado in listaEstados)
                {
                    <tr>
                        <td>@estado.Id</td>
                        <td>@estado.Nombre</td>
                        <td>@estado.Descripcion</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                    @onclick="@(() => CargarEnFormulario(estado))">
                                Cargar
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
}

@code {
    private List<Estado> listaEstados = new();
    [SupplyParameterFromForm]
    private Estado estadoActual { get; set; } = new();
    private bool existeEstado = false;
    private string textoBotonGuardar = "Crear";
    private string mensaje = "";
    private string claseAviso = "alert alert-info";
    private bool cargando = false;
    private const string urlBaseApi = "api/estado";

protected override async Task OnAutenticacionVerificada()
{
    await CargarEstados(); // Usar esta versi√≥n temporalmente
    StateHasChanged();
}
private async Task VerificarEstadoAutenticacion()
{
    try
    {
        var autenticado = await ServicioAuth.EstaAutenticadoAsync();
        var rutaActual = "/estados";
        var tienePermiso = await ServicioAuth.TienePermisoParaRutaAsync(rutaActual);
        
        Console.WriteLine($"=== DIAGN√ìSTICO AUTENTICACI√ìN ===");
        Console.WriteLine($"Autenticado: {autenticado}");
        Console.WriteLine($"Tiene permiso para /estados: {tienePermiso}");
        Console.WriteLine($"Ruta verificada: {rutaActual}");
        
        mensaje = $"Autenticado: {autenticado} | Permiso /estados: {tienePermiso}";
        
        if (autenticado && !tienePermiso)
        {
            mensaje += " ‚ö†Ô∏è - Est√°s autenticado pero sin permisos para esta ruta";
            claseAviso = "alert alert-warning";
        }
        else if (autenticado && tienePermiso)
        {
            mensaje += " ‚úÖ - Tienes acceso completo";
            claseAviso = "alert alert-success";
        }
        else
        {
            claseAviso = "alert alert-danger";
        }
    }
    catch (Exception ex)
    {
        mensaje = $"Error en verificaci√≥n: {ex.Message}";
        claseAviso = "alert alert-danger";
        Console.WriteLine($"ERROR: {ex}");
    }
}

private async Task CargarEstados()
{
    try
    {
        Console.WriteLine("üîç CARGANDO ESTADOS...");
        cargando = true;
        StateHasChanged();

        // Usar el servicio API gen√©rico que ya maneja autenticaci√≥n
        var respuesta = await servicioApi.ObtenerTodosAsync<Estado>("estado");
        
        if (respuesta != null && respuesta.Any())
        {
            listaEstados = respuesta;
            mensaje = $"‚úÖ Se cargaron {listaEstados.Count} estado(s)";
            claseAviso = "alert alert-success";
            Console.WriteLine($"üìä Estados cargados: {listaEstados.Count}");
        }
        else
        {
            CargarEstadosDePrueba();
            mensaje = "No se pudieron cargar estados desde API, usando datos de prueba";
            claseAviso = "alert alert-warning";
        }
    }
    catch (Exception error)
    {
        Console.WriteLine($"üí• ERROR: {error.Message}");
        CargarEstadosDePrueba();
        mensaje = $"Error: {error.Message}, usando datos de prueba";
        claseAviso = "alert alert-warning";
    }
    finally
    {
        cargando = false;
        StateHasChanged();
    }
}

private void CargarEstadosDePrueba()
{
    listaEstados = new List<Estado>
    {
        new Estado { Id = 1, Nombre = "Pendiente", Descripcion = "Estado inicial de un proyecto o actividad" },
        new Estado { Id = 2, Nombre = "En Progreso", Descripcion = "Proyecto o actividad en desarrollo" },
        new Estado { Id = 3, Nombre = "Completado", Descripcion = "Proyecto o actividad finalizado exitosamente" },
        new Estado { Id = 4, Nombre = "En Pausa", Descripcion = "Proyecto o actividad temporalmente detenido" },
        new Estado { Id = 5, Nombre = "Cancelado", Descripcion = "Proyecto o actividad cancelado permanentemente" },
        new Estado { Id = 6, Nombre = "Aprobado", Descripcion = "Estado aprobado para presupuestos o documentos" },
        new Estado { Id = 7, Nombre = "Rechazado", Descripcion = "Estado rechazado para presupuestos o documentos" },
        new Estado { Id = 8, Nombre = "En Revisi√≥n", Descripcion = "Proyecto o documento en proceso de revisi√≥n" }
    };
    Console.WriteLine($"üìã Datos de prueba cargados: {listaEstados.Count} estados");
}

    // MANT√âN TODOS LOS DEM√ÅS M√âTODOS EXACTAMENTE COMO EST√ÅN:
    private async Task BuscarPorId()
    {
        LimpiarMensajes();
        if (estadoActual.Id <= 0)
        {
            mensaje = "Debe indicar un ID v√°lido para buscar.";
            claseAviso = "alert alert-warning";
            return;
        }

        try
        {
            var cliente = fabricaHttp.CreateClient("ApiEstados");
            var ruta = $"{urlBaseApi}/id/{estadoActual.Id}";
            var respuesta = await cliente.GetFromJsonAsync<RespuestaApi<List<Estado>>>(ruta);
            var encontrado = respuesta?.Datos?.FirstOrDefault();

            if (encontrado is not null)
            {
                estadoActual = new Estado
                {
                    Id = encontrado.Id,
                    Nombre = encontrado.Nombre,
                    Descripcion = encontrado.Descripcion
                };
                existeEstado = true;
                textoBotonGuardar = "Actualizar";
                mensaje = "Estado cargado en el formulario.";
                claseAviso = "alert alert-success";
            }
            else
            {
                existeEstado = false;
                textoBotonGuardar = "Crear";
                mensaje = "Estado no encontrado.";
                claseAviso = "alert alert-warning";
            }
        }
        catch (Exception error)
        {
            existeEstado = false;
            textoBotonGuardar = "Crear";
            mensaje = $"Error al buscar estado: {error.Message}";
            claseAviso = "alert alert-danger";
        }
    }

    private async Task GuardarSegunEstado()
    {
        if (existeEstado)
            await ActualizarEstado();
        else
            await CrearEstado();
    }

    private async Task CrearEstado()
    {
        LimpiarMensajes();
        try
        {
            // Crear un objeto sin el campo Id para la solicitud POST
            var estadoParaCrear = new
            {
                Nombre = estadoActual.Nombre,
                Descripcion = estadoActual.Descripcion
            };
            if(Vacio(estadoParaCrear))
            {
                return;
            }
            var cliente = fabricaHttp.CreateClient("ApiEstados");
            var respuesta = await cliente.PostAsJsonAsync(urlBaseApi, estadoParaCrear);
            if (respuesta.IsSuccessStatusCode)
            {
                mensaje = "Estado creado correctamente.";
                claseAviso = "alert alert-success";
                await CargarEstados();
                LimpiarFormulario();
            }
            else
            {
                var detalle = await respuesta.Content.ReadAsStringAsync();
                mensaje = $"No se pudo crear el estado. Detalle: {detalle}";
                claseAviso = "alert alert-danger";
            }
        }
        catch (Exception error)
        {
            mensaje = $"Error al crear estado: {error.Message}";
            claseAviso = "alert alert-danger";
        }
    }

    private async Task ActualizarEstado()
    {
        LimpiarMensajes();
        if (estadoActual.Id <= 0)
        {
            mensaje = "Debe indicar un ID v√°lido para actualizar.";
            claseAviso = "alert alert-warning";
            return;
        }

        try
        {
            // Crear un objeto sin el campo Id para la solicitud PUT
            var estadoParaActualizar = new
            {
                Nombre = estadoActual.Nombre,
                Descripcion = estadoActual.Descripcion
            };
            if(Vacio(estadoParaActualizar))
            {
                return;
            }
            var cliente = fabricaHttp.CreateClient("ApiEstados");
            var ruta = $"{urlBaseApi}/id/{estadoActual.Id}";
            var respuesta = await cliente.PutAsJsonAsync(ruta, estadoParaActualizar);
            if (respuesta.IsSuccessStatusCode)
            {
                mensaje = "Estado actualizado correctamente.";
                claseAviso = "alert alert-success";
                await CargarEstados();
                existeEstado = true;
                textoBotonGuardar = "Actualizar";
            }
            else
            {
                var detalle = await respuesta.Content.ReadAsStringAsync();
                mensaje = $"No se pudo actualizar el estado. Detalle: {detalle}";
                claseAviso = "alert alert-danger";
            }
        }
        catch (Exception error)
        {
            mensaje = $"Error al actualizar estado: {error.Message}";
            claseAviso = "alert alert-danger";
        }
    }

    private async Task EliminarEstado()
    {
        LimpiarMensajes();
        if (estadoActual.Id <= 0)
        {
            mensaje = "Debe indicar un ID v√°lido para eliminar.";
            claseAviso = "alert alert-warning";
            return;
        }

        try
        {
            var cliente = fabricaHttp.CreateClient("ApiEstados");
            var ruta = $"{urlBaseApi}/id/{estadoActual.Id}";
            var respuesta = await cliente.DeleteAsync(ruta);
            if (respuesta.IsSuccessStatusCode)
            {
                mensaje = "Estado eliminado correctamente.";
                claseAviso = "alert alert-success";
                await CargarEstados();
                LimpiarFormulario();
            }
            else
            {
                var detalle = await respuesta.Content.ReadAsStringAsync();
                mensaje = $"No se pudo eliminar el estado. Detalle: {detalle}";
                claseAviso = "alert alert-danger";
            }
        }
        catch (Exception error)
        {
            mensaje = $"Error al eliminar estado: {error.Message}";
            claseAviso = "alert alert-danger";
        }
    }

    private async Task ProbarConexion()
    {
        LimpiarMensajes();
        try
        {
            var cliente = fabricaHttp.CreateClient("ApiEstados");
            var respuesta = await cliente.GetAsync(urlBaseApi);
            if (respuesta.IsSuccessStatusCode)
            {
                mensaje = "Conexi√≥n con la API verificada.";
                claseAviso = "alert alert-success";
            }
            else
            {
                mensaje = $"La API respondi√≥ con estado {(int)respuesta.StatusCode}.";
                claseAviso = "alert alert-warning";
            }
        }
        catch (Exception error)
        {
            mensaje = $"Error de conexi√≥n a la API: {error.Message}";
            claseAviso = "alert alert-danger";
        }
    }

    private void CargarEnFormulario(Estado estado)
    {
        estadoActual = new Estado
        {
            Id = estado.Id,
            Nombre = estado.Nombre,
            Descripcion = estado.Descripcion
        };
        existeEstado = true;
        textoBotonGuardar = "Actualizar";
        mensaje = "Estado seleccionado desde el listado.";
        claseAviso = "alert alert-info";
    }

    private void LimpiarMensajes()
    {
        mensaje = "";
        claseAviso = "alert alert-info";
    }

    private void LimpiarFormulario()
    {
        estadoActual = new Estado();
        existeEstado = false;
        textoBotonGuardar = "Crear";
        LimpiarMensajes();
    }
    
    private bool Vacio(dynamic p)
    {
        if(string.IsNullOrWhiteSpace(p.Nombre)||string.IsNullOrWhiteSpace(p.Descripcion))
        {
            mensaje="Error: Campo Vacio";
            return true;
        }
        return false;
    }
}