@page "/archivo_entregables"

@using FrontendBlazorApi.Models
@using FrontendBlazorApi.Servicios
@inject IHttpClientFactory fabricaHttp
@inject ServicioApiGenerico servicioApi
@inherits PaginaAutenticada
@rendermode InteractiveServer

<PageTitle>Archivo - Entregable</PageTitle>

@if (!AutenticacionVerificada)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 text-muted">Verificando autenticación...</p>
    </div>
}
else
{
    <h3>Relación Archivo ↔ Entregable</h3>

    <div class="mb-3 d-flex gap-2">
        <button type="button" class="btn btn-outline-primary" @onclick="CargarRelaciones">Mostrar todos</button>
        <button type="button" class="btn btn-outline-dark" @onclick="LimpiarFormulario">Limpiar</button>
    </div>

    @if (!string.IsNullOrWhiteSpace(mensaje))
    {
        <div class="@claseAviso">@mensaje</div>
    }

    <h4>Formulario de Relación</h4>
    <EditForm Model="relacionActual" OnValidSubmit="GuardarSegunEstado">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label">Archivo</label>
                <select class="form-control" @bind="relacionActual.IdArchivo">
                    <option value="0">Seleccione un archivo</option>
                    @foreach (var arch in listaArchivos)
                    {
                        <option value="@arch.Id">@arch.Nombre</option>
                    }
                </select>
            </div>

            <div class="col-md-6">
                <label class="form-label">Entregable</label>
                <select class="form-control" @bind="relacionActual.IdEntregable">
                    <option value="0">Seleccione un entregable</option>
                    @foreach (var ent in listaEntregables)
                    {
                        <option value="@ent.Id">@ent.Titulo</option>
                    }
                </select>
            </div>
        </div>

        <div class="mt-3 d-flex flex-wrap gap-2">
            <button type="submit" class="btn btn-primary">@textoBotonGuardar</button>
            <button type="button" class="btn btn-secondary" @onclick="BuscarRelacion">Buscar</button>
            <button type="button" class="btn btn-danger" @onclick="EliminarRelacion" disabled="@(!existeRelacion)">Eliminar</button>
        </div>
    </EditForm>

    <hr />

    @if (cargando)
    {
        <div class="text-center py-3">
            <div class="spinner-border text-primary"></div>
        </div>
    }
    else if (listaRelaciones.Count == 0)
    {
        <div class="alert alert-info">No hay relaciones registradas.</div>
    }
    else
    {
        <table class="table table-striped table-bordered align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Archivo</th>
                    <th>Entregable</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var r in listaRelaciones)
                {
                    <tr>
                        <td>@ObtenerNombreArchivo(r.IdArchivo)</td>
                        <td>@ObtenerNombreEntregable(r.IdEntregable)</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary"
                                    @onclick="@(() => CargarEnFormulario(r))">
                                Editar
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <div class="mt-3">
            <span class="badge bg-primary">Total: @listaRelaciones.Count relaciones</span>
        </div>
    }
}

@code {
    private List<ArchivoEntregable> listaRelaciones = new();
    private List<Archivo> listaArchivos = new();
    private List<Entregable> listaEntregables = new();

    private ArchivoEntregable relacionActual { get; set; } = new();

    private bool existeRelacion = false;
    private string textoBotonGuardar = "Crear";
    private string mensaje = "";
    private string claseAviso = "alert alert-info";
    private bool cargando = false;

    private const string urlBaseApi = "api/archivo_entregable";

    protected override async Task OnAutenticacionVerificada()
    {
        await CargarArchivos();
        await CargarEntregables();
        await CargarRelaciones();
    }

    private async Task CargarRelaciones()
    {
        try
        {
            cargando = true;
            listaRelaciones = await servicioApi.ObtenerTodosAsync<ArchivoEntregable>("archivo_entregable")
                              ?? new List<ArchivoEntregable>();

            mensaje = $"Se cargaron {listaRelaciones.Count} relación(es).";
            claseAviso = "alert alert-success";
        }
        catch (Exception ex)
        {
            mensaje = $"Error al cargar relaciones: {ex.Message}";
            claseAviso = "alert alert-danger";
        }
        finally
        {
            cargando = false;
        }
    }

    private async Task CargarArchivos()
    {
        listaArchivos = await servicioApi.ObtenerTodosAsync<Archivo>("archivo") ?? new();
    }

    private async Task CargarEntregables()
    {
        listaEntregables = await servicioApi.ObtenerTodosAsync<Entregable>("entregable") ?? new();
    }

    private async Task BuscarRelacion()
    {
        LimpiarMensajes();

        if (relacionActual.IdArchivo <= 0 || relacionActual.IdEntregable <= 0)
        {
            mensaje = "Debe seleccionar Archivo y Entregable.";
            claseAviso = "alert alert-warning";
            return;
        }

        try
        {
            var cliente = fabricaHttp.CreateClient("ApiArchivo_Entregables");
            var ruta = $"{urlBaseApi}/{relacionActual.IdArchivo}/{relacionActual.IdEntregable}";
            var resp = await cliente.GetFromJsonAsync<RespuestaApi<List<ArchivoEntregable>>>(ruta);

            var encontrada = resp?.Datos?.FirstOrDefault();

            if (encontrada != null)
            {
                relacionActual = new ArchivoEntregable
                {
                    IdArchivo = encontrada.IdArchivo,
                    IdEntregable = encontrada.IdEntregable
                };

                existeRelacion = true;
                textoBotonGuardar = "Actualizar";
                mensaje = "Relación encontrada.";
                claseAviso = "alert alert-success";
            }
            else
            {
                existeRelacion = false;
                textoBotonGuardar = "Crear";
                mensaje = "Relación no encontrada.";
                claseAviso = "alert alert-warning";
            }
        }
        catch (Exception ex)
        {
            mensaje = $"Error al buscar relación: {ex.Message}";
            claseAviso = "alert alert-danger";
        }
    }

    private async Task GuardarSegunEstado()
    {
        if (existeRelacion)
            await ActualizarRelacion();
        else
            await CrearRelacion();
    }

    private async Task CrearRelacion()
    {
        LimpiarMensajes();

        if (Vacio(relacionActual)) return;

        try
        {
            var cliente = fabricaHttp.CreateClient("ApiArchivo_Entregables");
            var resp = await cliente.PostAsJsonAsync(urlBaseApi, relacionActual);

            if (resp.IsSuccessStatusCode)
            {
                mensaje = "Relación creada correctamente.";
                claseAviso = "alert alert-success";
                await CargarRelaciones();
                LimpiarFormulario();
            }
            else
            {
                mensaje = "Error al crear relación.";
                claseAviso = "alert alert-danger";
            }
        }
        catch (Exception ex)
        {
            mensaje = $"Error al crear relación: {ex.Message}";
            claseAviso = "alert alert-danger";
        }
    }

    private async Task ActualizarRelacion()
    {
        LimpiarMensajes();

        if (Vacio(relacionActual)) return;

        try
        {
            var cliente = fabricaHttp.CreateClient("ApiArchivo_Entregables");
            var ruta = $"{urlBaseApi}/{relacionActual.IdArchivo}/{relacionActual.IdEntregable}";
            var resp = await cliente.PutAsJsonAsync(ruta, relacionActual);

            if (resp.IsSuccessStatusCode)
            {
                mensaje = "Relación actualizada.";
                claseAviso = "alert alert-success";
                await CargarRelaciones();
            }
            else
            {
                mensaje = "No se pudo actualizar.";
                claseAviso = "alert alert-danger";
            }
        }
        catch (Exception ex)
        {
            mensaje = $"Error: {ex.Message}";
            claseAviso = "alert alert-danger";
        }
    }

    private async Task EliminarRelacion()
    {
        LimpiarMensajes();

        if (relacionActual.IdArchivo <= 0 || relacionActual.IdEntregable <= 0)
        {
            mensaje = "Debe seleccionar una relación válida.";
            claseAviso = "alert alert-warning";
            return;
        }

        try
        {
            var cliente = fabricaHttp.CreateClient("ApiArchivo_Entregables");
            var ruta = $"{urlBaseApi}/{relacionActual.IdArchivo}/{relacionActual.IdEntregable}";
            var resp = await cliente.DeleteAsync(ruta);

            if (resp.IsSuccessStatusCode)
            {
                mensaje = "Relación eliminada.";
                claseAviso = "alert alert-success";
                await CargarRelaciones();
                LimpiarFormulario();
            }
            else
            {
                mensaje = "No se pudo eliminar.";
                claseAviso = "alert alert-danger";
            }
        }
        catch (Exception ex)
        {
            mensaje = $"Error al eliminar: {ex.Message}";
            claseAviso = "alert alert-danger";
        }
    }

    private void CargarEnFormulario(ArchivoEntregable r)
    {
        relacionActual = new ArchivoEntregable
        {
            IdArchivo = r.IdArchivo,
            IdEntregable = r.IdEntregable
        };

        existeRelacion = true;
        textoBotonGuardar = "Actualizar";
    }

    private bool Vacio(ArchivoEntregable p)
    {
        if (p.IdArchivo <= 0)
        {
            mensaje = "Debe seleccionar un Archivo.";
            claseAviso = "alert alert-warning";
            return true;
        }

        if (p.IdEntregable <= 0)
        {
            mensaje = "Debe seleccionar un Entregable.";
            claseAviso = "alert alert-warning";
            return true;
        }

        return false;
    }

    private void LimpiarFormulario()
    {
        relacionActual = new ArchivoEntregable();
        existeRelacion = false;
        textoBotonGuardar = "Crear";
        LimpiarMensajes();
    }

    private void LimpiarMensajes()
    {
        mensaje = "";
        claseAviso = "alert alert-info";
    }

    private string ObtenerNombreArchivo(int id)
    {
        return listaArchivos.FirstOrDefault(a => a.Id == id)?.Nombre ?? "-";
    }

    private string ObtenerNombreEntregable(int id)
    {
        return listaEntregables.FirstOrDefault(e => e.Id == id)?.Titulo ?? "-";
    }
}
