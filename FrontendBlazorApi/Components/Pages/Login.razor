@page "/login"
@rendermode InteractiveServer
@using FrontendBlazorApi.Servicios
@inject NavigationManager navegador
@inject ServicioAutenticacion servicioAuth
@inject ServicioApiGenerico servicioApi

<PageTitle>Inicio de Sesión</PageTitle>

<style>
    .login-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        position: relative;
        overflow: hidden;
    }

    .login-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grid" width="100" height="100" patternUnits="userSpaceOnUse"><path d="M 100 0 L 0 0 0 100" fill="none" stroke="white" stroke-width="0.5" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
        opacity: 0.3;
    }

    .login-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
        max-width: 1000px;
        width: 100%;
        margin: 20px;
        display: flex;
        position: relative;
        z-index: 1;
    }

    .login-image-section {
        flex: 1;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 60px 40px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white;
        position: relative;
        overflow: hidden;
    }

    .login-image-section::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        animation: pulse 15s ease-in-out infinite;
    }

    @@keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }

    .login-image-icon {
        font-size: 120px;
        margin-bottom: 30px;
        animation: float 3s ease-in-out infinite;
        position: relative;
        z-index: 1;
    }

    @@keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-20px); }
    }

    .login-image-text h2 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 15px;
        position: relative;
        z-index: 1;
    }

    .login-image-text p {
        font-size: 1.1rem;
        opacity: 0.9;
        position: relative;
        z-index: 1;
    }

    .login-form-section {
        flex: 1;
        padding: 60px 50px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .login-form-title {
        font-size: 2rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 10px;
    }

    .login-form-subtitle {
        color: #666;
        margin-bottom: 40px;
    }

    .form-floating-custom {
        position: relative;
        margin-bottom: 25px;
    }

    .form-floating-custom .form-control {
        height: 60px;
        border-radius: 12px;
        border: 2px solid #e0e0e0;
        padding: 20px 20px 20px 55px;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .form-floating-custom .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    .form-floating-custom .input-icon {
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
        font-size: 1.3rem;
        z-index: 10;
    }

    .form-floating-custom .form-control:focus ~ .input-icon {
        color: #667eea;
    }

    .btn-login {
        height: 60px;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 600;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-login:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .btn-login:active {
        transform: translateY(0);
    }

    .login-footer {
        margin-top: 30px;
        text-align: center;
        color: #999;
        font-size: 0.9rem;
    }

    @@media (max-width: 768px) {
        .login-card {
            flex-direction: column;
        }

        .login-image-section {
            padding: 40px 20px;
        }

        .login-form-section {
            padding: 40px 30px;
        }

        .login-image-icon {
            font-size: 80px;
        }

        .login-image-text h2 {
            font-size: 1.8rem;
        }
    }

    .alert-modern {
        border-radius: 12px;
        border: none;
        padding: 15px 20px;
        margin-bottom: 20px;
        animation: slideDown 0.3s ease-out;
    }

    @@keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<div class="login-container">
    <div class="login-card">
        <!-- Sección de imagen/ilustración izquierda -->
        <div class="login-image-section">
            <div class="login-image-icon">
                <i class="bi bi-shield-lock-fill"></i>
            </div>
            <div class="login-image-text text-center">
                <h2>Bienvenido de nuevo</h2>
                <p>Sistema de Gestión Empresarial</p>
                <p class="mt-4">
                    <i class="bi bi-check-circle me-2"></i>Gestión de Facturas<br>
                    <i class="bi bi-check-circle me-2"></i>Control de Inventario<br>
                    <i class="bi bi-check-circle me-2"></i>Administración de Clientes
                </p>
            </div>
        </div>

        <!-- Sección de formulario derecha -->
        <div class="login-form-section">
            <div class="login-form-title">Iniciar Sesión</div>
            <div class="login-form-subtitle">Ingrese sus credenciales para continuar</div>

            <!-- Mensajes de alerta -->
            @if (!string.IsNullOrEmpty(mensaje))
            {
                <div class="alert @claseAviso alert-modern" role="alert">
                    <i class="bi @iconoMensaje me-2"></i>@mensaje
                </div>
            }

            <!-- Formulario de login -->
            
            <EditForm Model="credenciales" OnValidSubmit="IniciarSesion" FormName="FormularioLogin">
                <DataAnnotationsValidator />

                <!-- Campo de usuario/email -->
                <div class="form-floating-custom">
                    <i class="bi bi-person-circle input-icon"></i>
                    <InputText class="form-control"
                               @bind-Value="credenciales.Usuario"
                               placeholder="Correo electrónico"
                               autocomplete="username" />
                </div>

                <!-- Campo de contraseña -->
                <div class="form-floating-custom">
                    <i class="bi bi-lock-fill input-icon"></i>
                    <InputText type="password"
                               class="form-control"
                               @bind-Value="credenciales.Contrasena"
                               placeholder="Contraseña"
                               autocomplete="current-password" />
                </div>

                <!-- Botón de envío -->
                <button type="submit" class="btn btn-login w-100" disabled="@cargando">
                    @if (cargando)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        <span>Verificando...</span>
                    }
                    else
                    {
                        <i class="bi bi-box-arrow-in-right me-2"></i>
                        <span>Iniciar Sesión</span>
                    }
                </button>
            </EditForm>

            <!-- Footer del formulario -->
            <div class="login-footer">
                <i class="bi bi-shield-check me-1"></i>
                Conexión segura y encriptada
            </div>
        </div>
    </div>
</div>

@code {
    private Credenciales credenciales = new();
    private string mensaje = "";
    private string claseAviso = "alert-info";
    private string iconoMensaje = "bi-info-circle";
    private bool cargando = false;

    private async Task IniciarSesion()
    {
        try
        {
            cargando = true;
            MostrarMensaje("Verificando credenciales...", "info");

            // 1. Obtener token usando ServicioApiGenerico
            var datosToken = new
            {
                tabla = "usuario",
                campoUsuario = "email",
                campoContrasena = "contrasena",
                usuario = credenciales.Usuario,
                contrasena = credenciales.Contrasena
            };

            var resultado = await servicioApi.PostAsync<RespuestaToken>("api/Autenticacion/token", datosToken);

            if (resultado == null || string.IsNullOrEmpty(resultado.Token))
            {
                MostrarMensaje("No se recibió un token válido del servidor", "warning");
                return;
            }

            // 2. Guardar token en ServicioAutenticacion
            await servicioAuth.IniciarSesionAsync(resultado.Token, credenciales.Usuario);

            // 3. Cargar TODAS las rutas de TODOS los roles del usuario que hizo login
            try
            {
                // Obtener todos los rol_usuario y filtrar por email
                var todosRolUsuario = await servicioApi.ObtenerTodosAsync<RolUsuario>("rol_usuario");
                var rolesDelUsuario = todosRolUsuario?.Where(ru => ru.FkEmail == credenciales.Usuario).ToList();

                if (rolesDelUsuario != null && rolesDelUsuario.Count > 0)
                {
                    // Obtener todos los roles
                    var todosRoles = await servicioApi.ObtenerTodosAsync<Rol>("rol");

                    // Obtener nombres de los roles del usuario
                    var nombresRolesUsuario = rolesDelUsuario
                        .Select(ru => todosRoles?.FirstOrDefault(r => r.IdRol == ru.FkIdRol)?.Nombre)
                        .Where(nombre => !string.IsNullOrEmpty(nombre))
                        .ToList();

                    if (nombresRolesUsuario.Count > 0)
                    {
                        // Obtener TODAS las rutasrol y filtrar por TODOS los roles del usuario
                        var todasRutasRol = await servicioApi.ObtenerTodosAsync<RutaRol>("rutarol");
                        var rutasDelUsuario = todasRutasRol?
                            .Where(rr => nombresRolesUsuario.Contains(rr.NombreRol))
                            .Distinct()
                            .ToList();

                        if (rutasDelUsuario != null && rutasDelUsuario.Count > 0)
                        {
                            await servicioAuth.GuardarRutasRolAsync(rutasDelUsuario);
                        }
                    }
                }
            }
            catch
            {
                // Si falla cargar permisos, continuar igual
            }

            MostrarMensaje("¡Inicio de sesión exitoso! Redirigiendo...", "success");
            await Task.Delay(1500);
            navegador.NavigateTo("/home", forceLoad: true);
        }
        catch (Exception ex)
        {
            MostrarMensaje($"Error: {ex.Message}", "danger");
        }
        finally
        {
            cargando = false;
        }
    }

    private void MostrarMensaje(string texto, string tipo)
    {
        mensaje = texto;
        claseAviso = tipo switch
        {
            "success" => "alert-success",
            "danger" => "alert-danger",
            "warning" => "alert-warning",
            _ => "alert-info"
        };
        iconoMensaje = tipo switch
        {
            "success" => "bi-check-circle-fill",
            "danger" => "bi-exclamation-triangle-fill",
            "warning" => "bi-exclamation-circle-fill",
            _ => "bi-info-circle-fill"
        };
    }

    private class Credenciales
    {
        public string Usuario { get; set; } = "";
        public string Contrasena { get; set; } = "";
    }

    private class RespuestaToken
    {
        public string? Token { get; set; }
    }

    private class RespuestaConsulta
    {
        public List<Dictionary<string, object>>? Resultados { get; set; }
    }

    private class RolUsuario
    {
        [System.Text.Json.Serialization.JsonPropertyName("fkemail")]
        public string? FkEmail { get; set; }

        [System.Text.Json.Serialization.JsonPropertyName("fkidrol")]
        public int FkIdRol { get; set; }
    }

    private class Rol
    {
        [System.Text.Json.Serialization.JsonPropertyName("id")]
        public int IdRol { get; set; }

        [System.Text.Json.Serialization.JsonPropertyName("nombre")]
        public string? Nombre { get; set; }
    }

    // Métodos auxiliares para extraer valores de Dictionary
    private int ObtenerInt(Dictionary<string, object> dict, string key)
    {
        if (dict.TryGetValue(key, out var valor) && valor != null)
        {
            if (valor is int i) return i;
            if (int.TryParse(valor.ToString(), out var resultado)) return resultado;
        }
        return 0;
    }

    private string ObtenerString(Dictionary<string, object> dict, string key)
    {
        if (dict.TryGetValue(key, out var valor) && valor != null)
            return valor.ToString() ?? "";
        return "";
    }
}
