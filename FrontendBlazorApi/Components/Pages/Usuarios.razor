@page "/usuarios"
@using FrontendBlazorApi.Models
@using FrontendBlazorApi.Servicios
@using FrontendBlazorApi.Components
@using System.Text.Json
@inherits PaginaAutenticada
@inject ServicioApiGenerico servicioApi
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>Gestión de Usuarios</PageTitle>

<div class="container-fluid py-4">
    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary">
            <i class="bi bi-people-fill me-2"></i>Gestión de Usuarios y Roles
        </h2>
    </div>

    <!-- Mensajes -->
    @if (!string.IsNullOrEmpty(mensaje))
    {
        <div class="alert @estiloMensaje alert-dismissible fade show shadow-sm" role="alert">
            <i class="bi @iconoMensaje me-2"></i>@mensaje
            <button type="button" class="btn-close" @onclick="() => mensaje = string.Empty"></button>
        </div>
    }

    <!-- Barra de herramientas -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-info btn-sm" @onclick="ProbarConexion" disabled="@cargando">
                    <i class="bi bi-wifi me-1"></i> Probar Conexión
                </button>
                <button class="btn btn-primary btn-sm" @onclick="CargarUsuarios" disabled="@cargando">
                    <i class="bi bi-list-ul me-1"></i> Cargar Usuarios
                </button>
                <button class="btn btn-warning btn-sm" @onclick="LimpiarFormulario" disabled="@cargando">
                    <i class="bi bi-eraser me-1"></i> Limpiar Formulario
                </button>
            </div>
        </div>
    </div>

    <!-- Formulario de Usuario -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="bi bi-person-plus me-2"></i>
                @(modoEdicion ? "Editar Usuario" : "Nuevo Usuario")
            </h5>
        </div>
        <div class="card-body">
            <EditForm Model="usuarioActual" OnValidSubmit="GuardarUsuario" FormName="formUsuario">
                <DataAnnotationsValidator />

                <div class="row g-3">
                    <!-- Email -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">
                            <i class="bi bi-envelope"></i> Email (Usuario)
                        </label>
                        <InputText type="email" class="form-control" @bind-Value="usuarioActual.Email"
                                   placeholder="correo@ejemplo.com" disabled="@modoEdicion" />
                        <ValidationMessage For="() => usuarioActual.Email" />
                    </div>

                    <!-- Contraseña -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">
                            <i class="bi bi-lock"></i> Contraseña
                        </label>
                        <InputText type="password" class="form-control" @bind-Value="usuarioActual.Contrasena"
                                   placeholder="******" />
                        <ValidationMessage For="() => usuarioActual.Contrasena" />
                        @if (modoEdicion)
                        {
                            <small class="text-muted">Dejar en blanco para mantener la contraseña actual</small>
                        }
                    </div>

                    <!-- Roles -->
                    <div class="col-md-12">
                        <label class="form-label fw-bold">
                            <i class="bi bi-shield-check"></i> Roles Asignados
                        </label>
                        <div class="card border-secondary">
                            <div class="card-body">
                                @if (roles == null || !roles.Any())
                                {
                                    <div class="alert alert-warning mb-0">
                                        <i class="bi bi-exclamation-triangle me-2"></i>
                                        No hay roles disponibles. Cree roles primero.
                                    </div>
                                }
                                else
                                {
                                    <div class="row">
                                        @foreach (var rol in roles)
                                        {
                                            <div class="col-md-4 col-sm-6 mb-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox"
                                                           id="rol_@rol.Id"
                                                           checked="@rolesSeleccionados.Contains(rol.Id)"
                                                           @onchange="e => ToggleRol(rol.Id, e.Value)" />
                                                    <label class="form-check-label" for="rol_@rol.Id">
                                                        <span class="badge @ObtenerColorRol(rol.Nombre)">
                                                            @rol.Nombre
                                                        </span>
                                                    </label>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                    <small class="text-muted mt-2 d-block">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Seleccionados: @rolesSeleccionados.Count de @roles.Count roles
                                    </small>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botones de acción -->
                <div class="d-flex gap-2 mt-4">
                    <button type="submit" class="btn @(modoEdicion ? "btn-warning" : "btn-success") shadow-sm" disabled="@cargando">
                        <i class="bi @(modoEdicion ? "bi-pencil-square" : "bi-plus-circle") me-1"></i>
                        @(modoEdicion ? "Actualizar" : "Crear") Usuario
                    </button>

                    @if (modoEdicion)
                    {
                        <button type="button" class="btn btn-secondary shadow-sm" @onclick="LimpiarFormulario" disabled="@cargando">
                            <i class="bi bi-x-circle me-1"></i> Cancelar
                        </button>
                    }
                </div>
            </EditForm>
        </div>
    </div>

    <!-- Tabla de Usuarios -->
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="bi bi-table me-2"></i>Listado de Usuarios
            </h5>
        </div>
        <div class="card-body">
            @if (cargando)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2 text-muted">Cargando usuarios...</p>
                </div>
            }
            else if (usuarios == null || !usuarios.Any())
            {
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>No hay usuarios registrados
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover table-striped align-middle">
                        <thead class="table-primary">
                            <tr>
                                <th><i class="bi bi-envelope me-1"></i>Email</th>
                                <th><i class="bi bi-shield-check me-1"></i>Roles Asignados</th>
                                <th class="text-center"><i class="bi bi-gear me-1"></i>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (UsuarioConRoles usuario in usuarios)
                            {
                                <tr>
                                    <td class="fw-bold">
                                        <i class="bi bi-person-circle me-2"></i>@usuario.Email
                                    </td>
                                    <td>
                                        @if (usuario.Roles != null && usuario.Roles.Any())
                                        {
                                            @foreach (var rol in usuario.Roles)
                                            {
                                                <span class="badge @ObtenerColorRol(rol.Nombre) me-1">
                                                    <i class="bi bi-shield-check me-1"></i>@rol.Nombre
                                                </span>
                                            }
                                        }
                                        else
                                        {
                                            <span class="text-muted">Sin roles asignados</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-outline-warning" @onclick="() => CargarParaEditar(usuario)"
                                                    title="Editar" disabled="@cargando">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" @onclick="() => EliminarUsuario(usuario.Email)"
                                                    title="Eliminar" disabled="@cargando">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="mt-3">
                    <span class="badge bg-primary">Total: @usuarios.Count usuarios</span>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private List<UsuarioConRoles> usuarios = new();
    private List<Rol> roles = new();
    private Usuario usuarioActual = new();
    private List<int> rolesSeleccionados = new();
    private bool cargando = false;
    private bool modoEdicion = false;
    private string mensaje = string.Empty;
    private string estiloMensaje = "alert-info";
    private string iconoMensaje = "bi-info-circle";

    protected override async Task OnAutenticacionVerificada()
    {
        // Este método se llama automáticamente después de verificar la autenticación
        await CargarDatosIniciales();
    }

    private async Task CargarDatosIniciales()
    {
        await Task.WhenAll(
            CargarRoles(),
            CargarUsuarios()
        );
    }

    private async Task ProbarConexion()
    {
        try
        {
            cargando = true;
            await servicioApi.ObtenerTodosAsync<Usuario>("usuario");
            MostrarMensaje("Conexión exitosa con la API", "success");
        }
        catch (Exception ex)
        {
            MostrarMensaje($"Error de conexión: {ex.Message}", "danger");
        }
        finally
        {
            cargando = false;
        }
    }

    private async Task CargarRoles()
    {
        try
        {
            var respuesta = await servicioApi.ObtenerTodosAsync<Rol>("rol");
            roles = respuesta ?? new List<Rol>();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar roles: {ex.Message}");
            roles = new List<Rol>();
        }
    }

    private async Task CargarUsuarios()
    {
        try
        {
            cargando = true;
            mensaje = string.Empty;

            // Parámetros vacíos para la función (no requiere parámetros)
            var parametros = new { };

            // Ejecutar stored procedure usando el servicio genérico
            var resultado = await servicioApi.EjecutarStoredProcedureConResultadosAsync("listar_usuarios_con_roles", parametros);

            if (resultado?.Resultados != null && resultado.Resultados.Count > 0)
            {
                var primeraFila = resultado.Resultados[0];
                string? jsonUsuarios = null;

                // MANEJO DE DIFERENCIAS ENTRE MOTORES DE BD (igual que Facturas)
                // SQL Server: JSON en columna "Resultado"
                // PostgreSQL: JSON directamente en primera columna
                if (primeraFila.ContainsKey("Resultado"))
                {
                    jsonUsuarios = primeraFila["Resultado"]?.ToString();
                }
                else if (primeraFila.ContainsKey("listar_usuarios_con_roles"))
                {
                    jsonUsuarios = primeraFila["listar_usuarios_con_roles"]?.ToString();
                }
                else if (primeraFila.Count > 0)
                {
                    var primerValor = primeraFila.Values.FirstOrDefault();
                    jsonUsuarios = primerValor?.ToString();
                }

                if (!string.IsNullOrEmpty(jsonUsuarios))
                {
                    // Deserializar el JSON a lista de usuarios con roles
                    var listaUsuarios = JsonSerializer.Deserialize<List<UsuarioConRoles>>(jsonUsuarios,
                        new JsonSerializerOptions { PropertyNameCaseInsensitive = true });

                    usuarios = listaUsuarios ?? new List<UsuarioConRoles>();
                    MostrarMensaje($"Se cargaron {usuarios.Count} usuarios con sus roles", "success");
                }
                else
                {
                    MostrarMensaje("No se pudo obtener el JSON de usuarios", "warning");
                    usuarios = new List<UsuarioConRoles>();
                }
            }
            else
            {
                MostrarMensaje("No hay usuarios registrados", "info");
                usuarios = new List<UsuarioConRoles>();
            }
        }
        catch (Exception ex)
        {
            MostrarMensaje($"Error al cargar usuarios: {ex.Message}", "danger");
            usuarios = new List<UsuarioConRoles>();
        }
        finally
        {
            cargando = false;
        }
    }

    private async Task GuardarUsuario()
    {
        try
        {
            cargando = true;

            // Validaciones básicas
            if (string.IsNullOrWhiteSpace(usuarioActual.Email))
            {
                MostrarMensaje("Por favor ingrese el email del usuario", "warning");
                return;
            }

            if (!modoEdicion && string.IsNullOrWhiteSpace(usuarioActual.Contrasena))
            {
                MostrarMensaje("Por favor ingrese una contraseña", "warning");
                return;
            }

            if (rolesSeleccionados.Count == 0)
            {
                MostrarMensaje("Por favor seleccione al menos un rol", "warning");
                return;
            }

            // Crear JSON de roles para el procedimiento almacenado
            var rolesJson = JsonSerializer.Serialize(rolesSeleccionados.Select(id => new { fkidrol = id }));

            if (modoEdicion)
            {
                // ACTUALIZAR USUARIO EXISTENTE CON STORED PROCEDURE
                var confirmacion = await JS.InvokeAsync<bool>("confirm",
                    $"¿Está seguro de actualizar el usuario {usuarioActual.Email}?");

                if (!confirmacion) return;

                // Preparar parámetros con prefijo p_ - IMPORTANTE: Convertir contraseña a string explícitamente
                var parametros = new Dictionary<string, object?>
                {
                    ["p_email"] = usuarioActual.Email,
                    ["p_contrasena"] = string.IsNullOrWhiteSpace(usuarioActual.Contrasena) ? null : usuarioActual.Contrasena?.ToString(),
                    ["p_roles"] = rolesJson
                };

                // Ejecutar el stored procedure con encriptación de contraseña
                await servicioApi.EjecutarStoredProcedureAsync("actualizar_usuario_con_roles", parametros, "p_contrasena");

                MostrarMensaje($"Usuario {usuarioActual.Email} actualizado exitosamente con sus roles", "success");
            }
            else
            {
                // CREAR NUEVO USUARIO CON STORED PROCEDURE - IMPORTANTE: Convertir contraseña a string explícitamente
                var parametros = new Dictionary<string, object?>
                {
                    ["p_email"] = usuarioActual.Email,
                    ["p_contrasena"] = usuarioActual.Contrasena?.ToString() ?? "",
                    ["p_roles"] = rolesJson
                };

                // Ejecutar el stored procedure con encriptación de contraseña
                await servicioApi.EjecutarStoredProcedureAsync("crear_usuario_con_roles", parametros, "p_contrasena");

                MostrarMensaje($"Usuario {usuarioActual.Email} creado exitosamente con contraseña encriptada y {rolesSeleccionados.Count} roles asignados", "success");
            }

            // Recargar usuarios y limpiar formulario
            await CargarUsuarios();
            LimpiarFormulario();
        }
        catch (Exception ex)
        {
            MostrarMensaje($"Error al guardar: {ex.Message}", "danger");
        }
        finally
        {
            cargando = false;
        }
    }

    private async Task EliminarUsuario(string email)
    {
        try
        {
            var confirmacion = await JS.InvokeAsync<bool>("confirm",
                $"¿Está seguro de eliminar el usuario {email}? Esta acción no se puede deshacer.");

            if (!confirmacion) return;

            cargando = true;

            // Ejecutar el SP eliminar_usuario_con_roles
            // Este SP elimina los roles asociados y luego el usuario en una transacción
            var parametros = new { p_email = email };
            await servicioApi.EjecutarStoredProcedureAsync("eliminar_usuario_con_roles", parametros);

            MostrarMensaje($"Usuario {email} eliminado exitosamente", "success");
            await CargarUsuarios();
        }
        catch (Exception ex)
        {
            MostrarMensaje($"Error al eliminar: {ex.Message}", "danger");
        }
        finally
        {
            cargando = false;
        }
    }

    private void CargarParaEditar(UsuarioConRoles usuario)
    {
        usuarioActual = new Usuario
            {
                Email = usuario.Email,
                Contrasena = string.Empty // No cargar contraseña por seguridad
            };

        // Cargar los IDs de los roles asignados
        rolesSeleccionados = usuario.Roles?.Select(r => r.IdRol).ToList() ?? new List<int>();
        modoEdicion = true;
        mensaje = string.Empty;
    }

    private void ToggleRol(int idRol, object? valorCheckbox)
    {
        var estaSeleccionado = valorCheckbox is bool valor && valor;

        if (estaSeleccionado && !rolesSeleccionados.Contains(idRol))
        {
            rolesSeleccionados.Add(idRol);
        }
        else if (!estaSeleccionado && rolesSeleccionados.Contains(idRol))
        {
            rolesSeleccionados.Remove(idRol);
        }
    }

    private void LimpiarFormulario()
    {
        usuarioActual = new Usuario();
        rolesSeleccionados = new List<int>();
        modoEdicion = false;
        mensaje = string.Empty;
    }

    private void MostrarMensaje(string texto, string tipo)
    {
        mensaje = texto;
        estiloMensaje = tipo switch
        {
            "success" => "alert-success",
            "danger" => "alert-danger",
            "warning" => "alert-warning",
            _ => "alert-info"
        };
        iconoMensaje = tipo switch
        {
            "success" => "bi-check-circle",
            "danger" => "bi-exclamation-triangle",
            "warning" => "bi-exclamation-circle",
            _ => "bi-info-circle"
        };
    }

    private string ObtenerColorRol(string nombreRol)
    {
        // Generar color consistente basado en hash del nombre
        var colores = new[] { "bg-primary", "bg-success", "bg-info", "bg-warning text-dark", "bg-danger", "bg-secondary" };
        var hash = Math.Abs(nombreRol.GetHashCode());
        return colores[hash % colores.Length];
    }
}
